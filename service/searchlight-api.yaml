dsl_version: 0.1.0
service:
  name: searchlight-api
  ports:
    - {{ searchlight.api_port }}
  containers:
    - name: searchlight-api
      image: searchlight-api
      # TODO(prazumovsky): add probes
      pre:
        - name: searchlight-elasticsearch-sync
          dependencies:
            - elasticsearch
            # {% if searchlight.services.nova %}
            - nova-api
            # {% endif %}
            # {% if searchlight.services.glance %}
            - glance-api
            # {% endif %}
            # {% if searchlight.services.neutron %}
            - neutron-server
            # {% endif %}
            # {% if searchlight.services.cinder %}
            - cinder-api
            # {% endif %}
          files:
            - searchlight-conf
          type: local
          command: searchlight-manage --config-file /etc/searchlight/searchlight.conf index sync --force
        - name: searchlight-user-create
          dependencies:
            - keystone-create-domain
          type: single
          command: openstack user create --domain {{ service_account.domain }} --password {{ searchlight.password }} {{ searchlight.user }}

        - name: searchlight-admin-role-add
          dependencies:
            - searchlight-user-create
          type: single
          command: openstack role add --project {{ service_account.project }} --user {{ searchlight.user }} admin

        - name: searchlight-service-create
          dependencies:
            - keystone
          type: single
          command: openstack service create --name searchlight --description "Searchlight Service" search

        - name: searchlight-public-endpoint-create
          dependencies:
            - searchlight-service-create
          type: single
          command: openstack endpoint create --region RegionOne search public {{ address('searchlight-api', searchlight.api_port, external=True, with_scheme=True) }}

        - name: searchlight-internal-endpoint-create
          dependencies:
            - searchlight-service-create
          type: single
          command: openstack endpoint create --region RegionOne search internal {{ address('searchlight-api', searchlight.api_port, with_scheme=True) }}

        - name: searchlight-admin-endpoint-create
          dependencies:
            - searchlight-service-create
          type: single
          command: openstack endpoint create --region RegionOne search admin {{ address('searchlight-api', searchlight.api_port, with_scheme=True) }}
      daemon:
        dependencies:
          - rabbitmq
        files:
          - searchlight-conf
        command: searchlight-api --config-file /etc/searchlight/searchlight.conf

files:
  searchlight-conf:
    path: /etc/searchlight/searchlight.conf
    content: searchlight.conf.j2
